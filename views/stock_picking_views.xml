<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_picking_form_inherit_packing_import" model="ir.ui.view">
        <field name="name">stock.picking.form.inherit.packing.import</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="arch" type="xml">
            <!-- Inserción de campos de control invisibles para la lógica de los botones -->
            <field name="partner_id" position="after">
                <field name="has_packing_list" invisible="1"/>
                <field name="packing_list_imported" invisible="1"/>
                <field name="spreadsheet_id" invisible="1"/>
                <field name="packing_list_file" invisible="1"/>
                <field name="packing_list_filename" invisible="1"/>
                <field name="worksheet_file" invisible="1"/>
                <field name="worksheet_filename" invisible="1"/>
            </field>
            
            <xpath expr="//header/button[@name='action_assign']" position="after">
                
                <!-- GRUPO 1: GESTIÓN DEL SPREADSHEET (PL / WS UNIFICADO) -->
                <!-- Botón principal para abrir la hoja de cálculo operativa -->
                <button name="action_open_packing_list_spreadsheet"
                        string="Abrir Spreadsheet PL/WS"
                        type="object"
                        class="btn-primary"
                        icon="fa-table"
                        invisible="state in ('done', 'cancel', 'draft') or picking_type_code != 'incoming'"/>

                <!-- GRUPO 2: PROCESAMIENTO DE PACKING LIST (ETAPA 1) -->
                <!-- Botón para procesar por primera vez (Crea los lotes) -->
                <button name="action_import_packing_list"
                        string="Procesar Packing List"
                        type="object"
                        class="btn-secondary"
                        icon="fa-cogs"
                        invisible="state in ('done', 'cancel', 'draft') or picking_type_code != 'incoming' or packing_list_imported or not spreadsheet_id"/>
                
                <!-- Botón para re-procesar si hubo cambios en la lista original -->
                <button name="action_import_packing_list"
                        string="Actualizar Cambios PL"
                        type="object"
                        class="btn-warning"
                        icon="fa-refresh"
                        invisible="state in ('done', 'cancel', 'draft') or picking_type_code != 'incoming' or not packing_list_imported or not spreadsheet_id"/>

                <!-- GRUPO 3: PROCESAMIENTO DE MEDIDAS REALES / WORKSHEET (ETAPA 2) -->
                <!-- Este botón procesa las columnas M y N del Spreadsheet (Alto/Ancho Real) -->
                <button name="action_import_worksheet"
                        string="Procesar Medidas Reales (WS)"
                        type="object"
                        class="btn-info"
                        icon="fa-check-square-o"
                        invisible="state in ('done', 'cancel', 'draft') or picking_type_code != 'incoming' or not packing_list_imported"/>

                <!-- GRUPO 4: SOPORTE EXTERNO (EXCEL) -->
                <!-- Descarga de plantilla PL para trabajo fuera de línea -->
                <button name="action_download_packing_template"
                        string="Plantilla PL (Excel)"
                        type="object"
                        class="btn-outline-secondary"
                        icon="fa-download"
                        invisible="state in ('done', 'cancel', 'draft') or picking_type_code != 'incoming' or packing_list_imported"/>

                <!-- Descarga de Worksheet para trabajo fuera de línea -->
                <button name="action_download_worksheet"
                        string="Exportar WS (Excel)"
                        type="object"
                        class="btn-outline-info"
                        icon="fa-file-excel-o"
                        invisible="state in ('done', 'cancel', 'draft') or picking_type_code != 'incoming' or not packing_list_imported"/>

            </xpath>
        </field>
    </record>
</odoo>